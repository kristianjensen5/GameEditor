<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Trump Game Trigger Editor (Overlay Version)</title>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: system-ui, sans-serif;
      background: #f5f5f7;
    }
    body {
      display: flex; flex-direction: column;
    }

    #app {
      flex: 1;
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "sidebar toolbar inspector"
        "sidebar main inspector";
      height: 100%;
    }

    .sidebar {
      grid-area: sidebar;
      border-right: 1px solid #ddd;
      background: #fafafa;
      padding: 10px;
      overflow-y: auto;
    }
    .sidebar h2 { font-size: 14px; margin: 0 0 6px; }

    .scene-item { margin-bottom: 4px; }
    .scene-header {
      font-size: 12px; font-weight: 600;
      cursor: pointer; padding: 3px 4px;
      border-radius: 4px;
      display: flex; justify-content: space-between;
    }
    .scene-header:hover { background: #ececec; }

    .trigger-list {
      margin: 2px 0 6px 8px;
      padding-left: 6px; border-left: 1px solid #ddd;
    }
    .trigger-item {
      font-size: 12px; padding: 2px 4px;
      border-radius: 4px; cursor: pointer;
      display: flex; justify-content: space-between;
    }
    .trigger-item:hover { background: #ececec; }
    .trigger-item.active {
      background: #2563eb; color: white;
    }

    .toolbar {
      grid-area: toolbar;
      display: flex; align-items: center;
      gap: 8px; padding: 8px 10px;
      border-bottom: 1px solid #ddd;
      background: white;
    }

    .main {
      grid-area: main;
      display: flex; flex-direction: column;
      padding: 8px; gap: 8px;
      overflow: hidden;
    }
    .preview-and-code {
      display: grid; grid-template-columns: 1.2fr 1fr;
      gap: 8px; height: 100%; min-height: 0;
    }

    .preview {
      position: relative;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      display: flex; flex-direction: column;
    }
    .preview-header {
      padding: 6px 10px;
      font-size: 12px; font-weight: 600;
      background: #f8f8fb;
    }

    #gameFrame {
      flex: 1;
      border: none;
      background: #222;
      pointer-events: none;
    }
    #gameOverlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: auto; /* overlay fanger klik */
    }

    .code-editor {
      display: flex; flex-direction: column;
      background: #0b1020;
      border-radius: 8px;
      border: 1px solid #222;
    }
    .code-header {
      padding: 6px 10px; color: #ddd;
      background: #111827;
      font-size: 12px; font-weight: 600;
    }
    #codeText {
      flex: 1; border: none; resize: none;
      font-family: ui-monospace, monospace;
      font-size: 12px; padding: 8px;
      outline: none; background: #0b1020; color: #e6edf3;
    }
    .code-footer {
      padding: 6px 8px;
      border-top: 1px solid #222;
      display: flex; justify-content: flex-end;
      background: #111827;
    }

    .inspector {
      grid-area: inspector;
      border-left: 1px solid #ddd;
      background: #fafafa; padding: 10px;
      overflow-y: auto;
    }
    .inspector h2 { margin: 0 0 8px; font-size: 14px; }

    .inspector .field-row { margin-bottom: 8px; }
    .inspector input, .inspector select, .inspector textarea {
      width: 100%; padding: 4px 6px;
      border: 1px solid #ccc; border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>

<body>
<div id="app">

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Scenes & triggers</h2>
    <div id="sceneList"></div>

    <button id="addTriggerBtn" style="margin-top:10px;width:100%;">+ New trigger in scene</button>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <label>Game URL:
      <input id="gameUrl" type="text" placeholder="Trumpspillet.html" style="min-width:180px;">
    </label>
    <button id="loadGameBtn">Load game</button>
    <button id="exportBtn">Export triggers.js</button>
    <span id="status" style="margin-left:auto;font-size:12px;color:#666;"></span>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="preview-and-code">

      <!-- GAME PREVIEW WITH OVERLAY -->
      <div class="preview">
        <div class="preview-header">Game preview</div>

        <iframe id="gameFrame" title="Game preview"></iframe>

        <!-- Overlay canvas -->
        <canvas id="gameOverlay"></canvas>
      </div>

      <!-- CODE EDITOR -->
      <div class="code-editor">
        <div class="code-header">onTrigger(ctx, api)</div>
        <textarea id="codeText" spellcheck="false"></textarea>
        <div class="code-footer">
          <button id="applyCodeBtn">Apply code to trigger</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inspector -->
  <div class="inspector">
    <h2>Trigger inspector</h2>
    <div id="inspectorContent">Vælg et trigger…</div>
  </div>

</div>


<!-- ========================================================= -->
<!-- ============= FULL JAVASCRIPT FOR EDITOR ================ -->
<!-- ========================================================= -->

<script type="module">
  import { triggers as importedTriggers } from "./triggers.js";

  /* ===========================================================
     EDITOR STATE
  ============================================================*/

  const state = {
    triggers: importedTriggers,
    currentScene: null,
    currentTriggerId: null,
  };

  const sceneListEl = document.getElementById("sceneList");
  const inspectorEl = document.getElementById("inspectorContent");
  const codeTextEl = document.getElementById("codeText");
  const statusEl = document.getElementById("status");
  const gameUrlEl = document.getElementById("gameUrl");
  const gameFrameEl = document.getElementById("gameFrame");
  const overlayCanvas = document.getElementById("gameOverlay");
  const overlayCtx = overlayCanvas.getContext("2d");

  let editorObjects = [];

  function setStatus(msg) {
    statusEl.textContent = msg;
    if (msg)
      setTimeout(() => {
        if (statusEl.textContent === msg) statusEl.textContent = "";
      }, 2500);
  }

  /* ===========================================================
     RENDER SIDEBAR (Scenes and triggers)
  ============================================================*/

  function renderSceneList() {
    const scenes = Object.keys(state.triggers);
    sceneListEl.innerHTML = "";

    scenes.forEach((sceneName) => {
      const wrapper = document.createElement("div");
      wrapper.className = "scene-item";

      const header = document.createElement("div");
      header.className = "scene-header";
      header.textContent = sceneName;

      const triggerList = document.createElement("div");
      triggerList.className = "trigger-list";

      const sceneTriggers = state.triggers[sceneName] || {};
      const ids = Object.keys(sceneTriggers);

      ids.forEach((id) => {
        const trig = sceneTriggers[id];

        const item = document.createElement("div");
        item.className = "trigger-item";
        if (
          state.currentScene === sceneName &&
          state.currentTriggerId === id
        ) {
          item.classList.add("active");
        }

        item.textContent = id + " (" + (trig.type || "") + ")";
        item.addEventListener("click", () => {
          state.currentScene = sceneName;
          state.currentTriggerId = id;
          renderSceneList();
          renderInspector();
          loadCode();
        });

        triggerList.appendChild(item);
      });

      wrapper.appendChild(header);
      wrapper.appendChild(triggerList);
      sceneListEl.appendChild(wrapper);
    });
  }

  /* ===========================================================
     INSPECTOR
  ============================================================*/

  function renderInspector() {
    const scene = state.currentScene;
    const id = state.currentTriggerId;

    if (!scene || !id) {
      inspectorEl.innerHTML = "Vælg en scene og et trigger…";
      return;
    }

    const trig = state.triggers[scene][id];
    if (!trig) {
      inspectorEl.innerHTML = "Trigger ikke fundet.";
      return;
    }

    inspectorEl.innerHTML = "";

    /* ID */
    inspectorEl.innerHTML += `
      <div class="field-row">
        <label>Trigger ID</label>
        <input value="${id}" readonly style="background:#eee;">
      </div>
    `;

    /* Label */
    inspectorEl.innerHTML += `
      <div class="field-row">
        <label>Label</label>
        <input id="insp_label" value="${trig.label || ""}">
      </div>
    `;

    /* Type */
    inspectorEl.innerHTML += `
      <div class="field-row">
        <label>Type</label>
        <select id="insp_type">
          <option value="interact">interact</option>
          <option value="proximity">proximity</option>
          <option value="click">click</option>
          <option value="event">event</option>
        </select>
      </div>
    `;

    /* Object */
    inspectorEl.innerHTML += `
      <div class="field-row">
        <label>Object (type/id)</label>
        <input id="insp_object" value="${trig.object || ""}">
      </div>
    `;

    /* Conditions */
    inspectorEl.innerHTML += `
      <div class="field-row">
        <label>Conditions (JSON)</label>
        <textarea id="insp_cond" style="min-height:80px;">${
          trig.conditions ? JSON.stringify(trig.conditions, null, 2) : ""
        }</textarea>
      </div>
    `;

    document.getElementById("insp_type").value = trig.type || "interact";

    // Wiring
    document.getElementById("insp_label").addEventListener("input", (ev) => {
      trig.label = ev.target.value;
      setStatus("Label opdateret");
    });

    document.getElementById("insp_type").addEventListener("change", (ev) => {
      trig.type = ev.target.value;
      renderSceneList();
      setStatus("Type opdateret");
    });

    document.getElementById("insp_object").addEventListener("input", (ev) => {
      trig.object = ev.target.value;
      setStatus("Object opdateret");
    });

    document.getElementById("insp_cond").addEventListener("change", (ev) => {
      const txt = ev.target.value.trim();
      if (!txt) {
        delete trig.conditions;
        setStatus("Conditions fjernet");
        return;
      }
      try {
        trig.conditions = JSON.parse(txt);
        setStatus("Conditions opdateret");
      } catch (err) {
        alert("Fejl i JSON: " + err.message);
      }
    });
  }

  /* ===========================================================
     LOAD & APPLY CODE
  ============================================================*/

  function loadCode() {
    const s = state.currentScene;
    const id = state.currentTriggerId;
    if (!s || !id) {
      codeTextEl.value = "";
      return;
    }

    const trig = state.triggers[s][id];
    if (typeof trig.onTrigger === "function") {
      codeTextEl.value = trig.onTrigger.toString();
    } else {
      codeTextEl.value = `function onTrigger(ctx, api) {\n  // TODO\n}`;
    }
  }

  function applyCode() {
    const s = state.currentScene;
    const id = state.currentTriggerId;
    if (!s || !id) return alert("Vælg et trigger først.");

    const trig = state.triggers[s][id];

    const src = codeTextEl.value.trim();
    try {
      const fn = eval("(" + src + ")");
      trig.onTrigger = fn;
      setStatus("Trigger-kode opdateret");
    } catch (err) {
      alert("Fejl i kode: " + err.message);
    }
  }

  /* ===========================================================
     EXPORT triggers.js
  ============================================================*/

  function serializeValue(val, indent = 0) {
    const ind = "  ".repeat(indent);

    if (typeof val === "function") return val.toString();
    if (typeof val === "number" || typeof val === "boolean")
      return String(val);
    if (typeof val === "string") return JSON.stringify(val);
    if (val === null) return "null";

    if (Array.isArray(val)) {
      if (val.length === 0) return "[]";
      let out = "[\n";
      val.forEach((v, i) => {
        out +=
          "  ".repeat(indent + 1) +
          serializeValue(v, indent + 1) +
          (i < val.length - 1 ? "," : "") +
          "\n";
      });
      out += ind + "]";
      return out;
    }

    if (typeof val === "object") {
      const keys = Object.keys(val);
      if (keys.length === 0) return "{}";
      let out = "{\n";
      keys.forEach((k, i) => {
        out +=
          "  ".repeat(indent + 1) +
          k +
          ": " +
          serializeValue(val[k], indent + 1) +
          (i < keys.length - 1 ? "," : "") +
          "\n";
      });
      out += ind + "}";
      return out;
    }

    return "null";
  }

  function exportTriggers() {
    const src =
      "// Generated by trigger-editor\n\nexport const triggers = " +
      serializeValue(state.triggers, 0) +
      ";\n";

    const blob = new Blob([src], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "triggers.js";
    a.click();

    URL.revokeObjectURL(url);
    setStatus("Downloaded triggers.js");
  }

  /* ===========================================================
     NEW TRIGGER
  ============================================================*/

  function addTrigger() {
    const scene = state.currentScene;
    if (!scene) return alert("Vælg en scene først.");

    const id = prompt("Nyt trigger-id:");
    if (!id) return;

    if (!state.triggers[scene]) state.triggers[scene] = {};
    if (state.triggers[scene][id])
      return alert("Trigger-id findes allerede.");

    state.triggers[scene][id] = {
      label: "New Trigger",
      type: "interact",
      object: "",
      onTrigger(ctx, api) {
        api.say("system", "New trigger!", 1000);
      },
    };

    state.currentTriggerId = id;
    renderSceneList();
    renderInspector();
    loadCode();
  }

  /* ===========================================================
     GAME OVERLAY & CLICK HANDLING
  ============================================================*/

  function resizeOverlay() {
    overlayCanvas.width = overlayCanvas.offsetWidth;
    overlayCanvas.height = overlayCanvas.offsetHeight;
  }

  function drawOverlay() {
    resizeOverlay();
    overlayCtx.clearRect(
      0,
      0,
      overlayCanvas.width,
      overlayCanvas.height
    );

    editorObjects.forEach((obj) => {
      overlayCtx.strokeStyle = "rgba(0,200,255,0.9)";
      overlayCtx.lineWidth = 2;
      overlayCtx.strokeRect(obj.x, obj.y, obj.w, obj.h);

      overlayCtx.fillStyle = "rgba(0,200,255,0.25)";
      overlayCtx.fillRect(obj.x, obj.y, obj.w, obj.h);

      overlayCtx.fillStyle = "cyan";
      overlayCtx.font = "12px sans-serif";
      overlayCtx.fillText(obj.id, obj.x + 4, obj.y - 4);
    });

    requestAnimationFrame(drawOverlay);
  }
  drawOverlay();

  overlayCanvas.addEventListener("click", (ev) => {
    const rect = overlayCanvas.getBoundingClientRect();
    const x = Math.round(ev.clientX - rect.left);
    const y = Math.round(ev.clientY - rect.top);

    if (gameFrameEl.contentWindow) {
      gameFrameEl.contentWindow.postMessage(
        { type: "EDITOR_CLICK", x, y },
        "*"
      );
    }

    const hit = editorObjects.find(
      (o) => x >= o.x && x <= o.x + o.w && y >= o.y && y <= o.y + o.h
    );

    if (hit) selectTriggerForObject(hit.id);
  });

  function selectTriggerForObject(objectId) {
    for (const scene of Object.keys(state.triggers)) {
      for (const trigId of Object.keys(state.triggers[scene])) {
        const trig = state.triggers[scene][trigId];
        if (trig.object === objectId) {
          state.currentScene = scene;
          state.currentTriggerId = trigId;
          renderSceneList();
          renderInspector();
          loadCode();
          return;
        }
      }
    }
  }

  /* ===========================================================
     COMMUNICATION: EDITOR ↔ GAME
  ============================================================*/

  window.addEventListener("message", (event) => {
    if (!event.data) return;

    if (event.data.type === "EDITOR_OBJECTS") {
      editorObjects = event.data.objects || [];
    }
  });

  function loadGame() {
    const url = gameUrlEl.value.trim();
    if (!url) return alert("Skriv en filsti eller URL til spillet.");

    gameFrameEl.src = url;

    // Når spillet loader, bed om objektliste
    gameFrameEl.onload = () => {
      gameFrameEl.contentWindow.postMessage(
        { type: "EDITOR_GET_OBJECTS" },
        "*"
      );
    };
  }

  /* ===========================================================
     HOOK BUTTONS
  ============================================================*/

  document
    .getElementById("addTriggerBtn")
    .addEventListener("click", addTrigger);
  document
    .getElementById("loadGameBtn")
    .addEventListener("click", loadGame);
  document
    .getElementById("exportBtn")
    .addEventListener("click", exportTriggers);
  document
    .getElementById("applyCodeBtn")
    .addEventListener("click", applyCode);

  /* ===========================================================
     INITIAL SELECTION
  ============================================================*/

  const scenes = Object.keys(state.triggers);
  if (scenes.length > 0) {
    state.currentScene = scenes[0];
    const ids = Object.keys(state.triggers[scenes[0]]);
    if (ids.length > 0) state.currentTriggerId = ids[0];
  }

  renderSceneList();
  renderInspector();
  loadCode();

</script>

</body>
</html>
